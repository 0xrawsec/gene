---
name: AddUser
tags:
  - ''
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $net: Image ~= '(?i:C:\\Windows\\Sys(tem32|wow64)\\net1?\.exe)'
  $command: CommandLine ~= 'user.*/ADD'
condition: $net and $command
severity: 10
actions: null
...

---
name: AlternateExplicitCredentialUse
tags:
  - Lateral
  - Security
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4648
  computers: []
matches:
  $iplh1: IpAddress = '-'
  $iplh2: IpAddress = '127.0.0.1'
  $iplh3: IpAddress = '::1'
  $wlpn: ProcessName ~= 'C:\\Windows\\System32\\winlogon\.exe'
  $wltsn: TargetServerName = 'localhost'
condition: '!$iplh1 and !$iplh2 and !$iplh3 and !$wlpn and !$wltsn'
severity: 4
actions: null
...

---
name: AnonymousNetworkLogon
tags:
  - Lateral
  - Security
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4624
  computers: []
matches:
  $logt: LogonType = '3'
  $kerb: AuthenticationPackageName = 'Kerberos'
  $user: TargetUserName = 'ANONYMOUS LOGON'
  $iplh1: IpAddress = '-'
  $iplh2: IpAddress = '127.0.0.1'
condition: $logt and !$kerb and $user and !$iplh1 and !$iplh2
severity: 5
actions: null
...

---
name: AutomatedRecursiveDir
tags:
  - Cmd
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $parent: ParentImage ~= '(?i:C:\\windows\\explorer.exe)'
  $exe: Image ~= '(?i:\\cmd.exe$)'
  $cmd: CommandLine ~= '(?i:dir.*?/s)'
condition: '!$parent and $exe and $cmd'
severity: 5
actions: null
...

---
name: BlacklistedDomain
tags:
  - DNS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-DNS-Client/Operational: []
  computers: []
matches:
  $domain-bl: extract('(?P<dom>\w+\.\w+$)',QueryName) in blacklist'
  $subdomain-bl: extract('(?P<sub>\w+\.\w+\.\w+$)',QueryName) in blacklist'
  $subsubdomain-bl: extract('(?P<subsub>\w+\.\w+\.\w+\.\w+$)',QueryName) in blacklist'
condition: $domainBL or $subdomainBL or $subsubdomainBL
severity: 10
actions: null
...

---
name: BlacklistedHash
tags:
  - Blacklist
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
      - 6
      - 7
  computers: []
matches:
  $md5: extract('MD5=(?P<md5>[A-F0-9]{32})', Hashes) in blacklist
  $sha1: extract('SHA1=(?P<sha1>[A-F0-9]{40})', Hashes) in blacklist
  $sha256: extract('SHA256=(?P<sha256>[A-F0-9]{64})', Hashes) in blacklist
condition: $md5 or $sha1 or $sha256
severity: 10
actions: null
...

---
name: BlacklistedImphash
tags:
  - Blacklist
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
      - 6
      - 7
  computers: []
matches:
  $imphash: extract('IMPHASH=(?P<imphash>[A-F0-9]{32})', Hashes) in blacklist
condition: $imphash
severity: 8
actions: null
...

---
name: BrowserChild
tags:
  - Browser
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $browser: ParentImage ~= '(?i:\\(iexplore|firefox|chrome|MicrosoftEdge|opera|vivaldi)\.exe)$'
condition: $browser
severity: 0
actions: null
...

---
name: BrowserSuspiciousChild
tags:
  - Browser
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $browser: ParentImage ~= '(?i:\\(iexplore|firefox|chrome|MicrosoftEdge|opera|vivaldi)\.exe)$'
  $susp: Image ~= '(?i:\\(certutil|rundll32|powershell|wscript|cscript|cmd|mshta|regsvr32|msbuild|installutil|regasm)\.exe)$'
  $allowed: CommandLine ~= '(?i:rundll32\.exe.*?(shell32\.dll"{0,1},(OpenAs_RunDLL|SHCreateLocalServerRunDll)|inetcpl\.cpl"{0,1},ClearMyTracksByProcess|ieframe.dll"{0,1},OpenURL))'
condition: $browser and $susp and !$allowed
severity: 6
actions: null
...

---
name: CanaryFileRead
tags:
  - Canary
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4663
  computers: []
matches:
  $access: AccessMask &= '0x1'
  $canary: ObjectName ~= '(?i:C:\\PutYourCanaryHere\\)'
condition: $access and $canary
severity: 10
actions: null
...

---
name: CertutilDownloader
tags:
  - Tools
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1140
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1140
matches:
  $certutil: Image ~= '(?i:^c:\\windows\\sys(tem32|wow64)\\certutil\.exe$)'
  $urlcache: 'CommandLine ~= ''(?i: -urlcache )'''
  $force: 'CommandLine ~= ''(?i: -f )'''
  $split: 'CommandLine ~= ''(?i: -split )'''
condition: $certutil and $urlcache and $force and $split
severity: 7
actions: null
...

---
name: CertutilSuspDecode
tags:
  - Tools
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1140
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1140
matches:
  $certutil: Image ~= '(?i:^c:\\windows\\sys(tem32|wow64)\\certutil\.exe$)'
  $suspdecode: 'CommandLine ~= ''(?i: -decode.*((?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))|(?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf))))'''
condition: $certutil and $suspdecode
severity: 7
actions: null
...

---
name: Cryptolocker
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 11
  computers: []
matches:
  $allowed: Image ~= '(?i:C:\\Windows\\Sys(wow64|tem32)\\)'
  $empty_ext: Extension = ''
  $count_by_ext: CountByExt >= '50'
condition: '!$empty_ext and $count_by_ext'
severity: 10
actions:
  - kill
  - blacklist
...

---
name: DefenderActionCriticallyFailed
tags:
  - Defender
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Windows Defender/Operational:
      - 1119
      - 5008
  computers: []
severity: 8
actions: null
...

---
name: DefenderBehaviourDetected
tags:
  - Defender
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Windows Defender/Operational:
      - 1015
  computers: []
severity: 8
actions: null
...

---
name: DefenderConfigChanged
tags:
  - Defender
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Windows Defender/Operational:
      - 5007
  computers: []
severity: 8
actions: null
...

---
name: DefenderFeatureDisabled
tags:
  - Defender
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Windows Defender/Operational:
      - 5010
      - 5012
  computers: []
severity: 10
actions: null
...

---
name: DefenderMalwareDetected
tags:
  - Defender
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Windows Defender/Operational:
      - 1006
      - 1116
  computers: []
severity: 10
actions: null
...

---
name: DomainInMisp
tags:
  - DNS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-DNS-Client/Operational: []
  computers: []
matches:
  $domain-bl: extract('(?P<dom>\w+\.\w+$)',QueryName) in misp'
  $subdomain-bl: extract('(?P<sub>\w+\.\w+\.\w+$)',QueryName) in misp'
  $subsubdomain-bl: extract('(?P<subsub>\w+\.\w+\.\w+\.\w+$)',QueryName) in misp'
condition: $domainBL or $subdomainBL or $subsubdomainBL
severity: 10
actions: null
...

---
name: DownloadPath
tags:
  - Heuristics
  - Exec
  - Download
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $path1: CommandLine ~= '(?i:\\Downloads\\)'
  $path2: CommandLine ~= '(?i:appdata\\local\\microsoft\\windows\\temporary internet
    files\\)'
condition: $path1 or $path2
severity: 1
actions: null
...

---
name: DriverLoadedNotValidSig
tags:
  - DriverLoaded
  - Signature
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 6
  computers: []
matches:
  $valid: SignatureStatus = 'Valid'
condition: '!$valid'
severity: 3
actions: null
...

---
name: DriverLoadedSuspiciousSigStatus
tags:
  - DriverLoaded
  - Signature
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 6
  computers: []
matches:
  $valid: SignatureStatus = 'Valid'
  $unavailable: SignatureStatus = 'Unavailable'
condition: '!$valid and !$unavailable'
severity: 7
actions: null
...

---
name: DriverLoadedUnusualPath
tags:
  - DriverLoaded
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 6
  computers: []
matches:
  $uspath1: ImageLoaded ~= '(?i:C:\\Windows\\Sys(wow64|tem32))'
  $uspath2: ImageLoaded ~= '(?i:C:\\Windows\\Sys(tem32|wow64)\\drivers)'
condition: '!$uspath1 and !$uspath2'
severity: 4
actions: null
...

---
name: EmbeddedHTTPLinkInCL
tags:
  - Heuristics
  - HTTP
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $http: CommandLine ~= '(?i:https?://)'
condition: $http
severity: 1
actions: null
...

---
name: EventClearing
tags:
  - PostExploit
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1070
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1070
matches:
  $im: Image ~= '(?i:\\wevtutil\.exe$)'
  $cmd: 'CommandLine ~= ''(?i: cl | clear-log )'''
condition: $im and $cmd
severity: 8
actions: null
...

---
name: ExecDownloadedDocument
tags:
  - Heuristics
  - Exec
  - Download
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $path1: Image ~= '(?i:appdata\\local\\microsoft\\windows\\temporary internet files\\)'
  $path2: Image ~= '(?i:\\Downloads\\)'
condition: $path1 or $path2
severity: 4
actions: null
...

---
name: ExecTimestomping
tags:
  - Timestomp
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 2
  computers: []
matches:
  $exec: TargetFilename ~= '(?i:((?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf))|(?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))))'
  $wl1: TargetFilename ~= '(?i:^C:\\Users\\.*?\\AppData\\Roaming\\Microsoft\\Windows\\Recent\\CustomDestinations)\\[A-Z0-9]{20}.temp$'
  $wl2: TargetFilename ~= '(?i:.*~tmp$)'
  $wl3: TargetFilename ~= '(?i:C:\\Windows\\SoftwareDistribution\\Download\\)'
condition: $exec and !($wl1 or $wl2 or $wl3)
severity: 6
actions: null
...

---
name: ExecutableADS
tags:
  - ADS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 15
  computers: []
meta:
  attack:
    - id: T1096
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1096
matches:
  $unk: Hash = 'Unknown'
  $impash: Hash ~= '(?i:(IMPHASH=00000000000000000000000000000000))'
condition: '!($impash or $unk)'
severity: 10
actions: null
...

---
name: ExecutableFileCreated
tags:
  - Heuristics
  - CreateFile
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 11
  computers: []
matches:
  $system: Image ~= '(?i:C:\\Windows)'
  $defender: Image ~= '(?i:((?i:C:\\(PROGRA~(1|2)|Program Files.*?)\\)Windows Defender\\MsMpEng\.exe|(?i:C:\\(PROGRA~3|ProgramData)\\)Microsoft\\Windows
    Defender\\platform\\.*?\\MpCmdRun\.exe))'
  $browsers: Image ~= '(?i:\\(iexplore|firefox|chrome|MicrosoftEdge|opera|vivaldi)\.exe)'
  $target: TargetFilename ~= '(?i:c:\\.*((?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))|(?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf)))$)'
condition: '!($system or $browsers or $defender) and $target'
severity: 7
actions: null
...

---
name: ExecutableUnkExt
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
matches:
  $knownext: ImageLoaded ~= '(?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))$'
condition: '!$knownext'
severity: 5
actions: null
...

---
name: ExplicitNetworkLogon
tags:
  - Lateral
  - Security
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4624
  computers: []
matches:
  $logt: LogonType = '3'
  $user: TargetUserName = 'ANONYMOUS LOGON'
  $iplh1: IpAddress = '-'
  $iplh2: IpAddress = '127.0.0.1'
  $enddol: TargetUserName ~= '\$$'
condition: $logt and !($user or $iplh1 or $iplh2 or $enddol)
severity: 5
actions: null
...

---
name: ExplorerInjection
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
meta:
  attack:
    - id: T1055
      tactic: privilege-escalation
      reference: https://attack.mitre.org/techniques/T1055
matches:
  $ga: GrantedAccess &= '0x20'
  $srcwl: SourceImage ~= '(?i:C:\\Windows\\System32\\(csrss)\.exe)'
  $hosted: SourceImage ~= '(?i:\\(lsass|svchost)\.exe$)'
  $win10shared: SourceServices ~= '(?i:(^|,)(AJRouter|AppIDSvc|AppMgmt|AssignedAccessManagerSvc|AxInstSV|BDESVC|BFE|BrokerInfrastructure|BTAGService|bthserv|CertPropSvc|CoreMessagingRegistrar|CscService|DcomLaunch|DeviceAssociationService|DevQueryBroker|diagsvc|DisplayEnhancementService|dmwappushservice|dot3svc|DsSvc|Eaphost|EFS|embeddedmode|EntAppSvc|fdPHost|FDResPub|fhsvc|FrameServer|GraphicsPerfSvc|hidserv|HvHost|icssvc|IKEEXT|IpxlatCfgSvc|KeyIso|KtmRm|lltdsvc|LxpSvc|mpssvc|MSiSCSI|NaturalAuthentication|NcaSvc|NcdAutoSetup|Netlogon|Netman|NetSetupSvc|NetTcpPortSharing|p2pimsvc|p2psvc|PeerDistSvc|pla|PNRPAutoReg|PNRPsvc|PolicyAgent|Power|PrintNotify|QWAVE|RasAuto|RasMan|RemoteAccess|RemoteRegistry|RetailDemo|RmSvc|RpcEptMapper|RpcSs|SamSs|SCardSvr|ScDeviceEnum|SCPolicySvc|seclogon|SensorService|SensrSvc|SessionEnv|SharedAccess|SharedRealitySvc|shpamsvc|SmsRouter|svsvc|SystemEventsBroker|TapiSrv|TermService|TroubleshootingSvc|tzautoupdate|UmRdpService|upnphost|VaultSvc|vmicguestinterface|vmicheartbeat|vmickvpexchange|vmicrdv|vmicshutdown|vmictimesync|vmicvmsession|vmicvss|W32Time|WalletService|WbioSrvc|wcncsvc|WebClient|Wecsvc|WEPHOSTSVC|wercplsupport|WFDSConMgrSvc|WiaRpc|WinRM|wlpasvc|WManSvc|workfolderssvc|WwanSvc|XblAuthManager|XblGameSave|XboxGipSvc|XboxNetApiSvc|AarSvc_\w+|BcastDVRUserService_\w+|BluetoothUserService_\w+|CaptureService_\w+|ConsentUxUserSvc_\w+|DeviceAssociationBrokerSvc_\w+|DevicePickerUserSvc_\w+|DevicesFlowUserSvc_\w+|MessagingService_\w+|OneSyncSvc_\w+|PimIndexMaintenanceSvc_\w+|PrintWorkflowUserSvc_\w+|UnistoreSvc_\w+|UserDataSvc_\w+)(,|$))'
  $win10svcs: SourceServices ~= '(?i:^(ALG|Appinfo|AppReadiness|AppVClient|AppXSvc|AudioEndpointBuilder|Audiosrv|autotimesvc|BITS|BthAvctpSvc|camsvc|CDPSvc|ClipSVC|COMSysApp|CryptSvc|defragsvc|DeviceInstall|Dhcp|diagnosticshub.standardcollector.service|DiagTrack|DispBrokerDesktopSvc|DmEnrollmentSvc|Dnscache|DoSvc|DPS|DsmSvc|DusmSvc|EventLog|EventSystem|Fax|FontCache|gpsvc|InstallService|iphlpsvc|LanmanServer|LanmanWorkstation|lfsvc|LicenseManager|lmhosts|LSM|MapsBroker|MSDTC|msiserver|NcbService|netprofm|NgcCtnrSvc|NgcSvc|NlaSvc|nsi|PcaSvc|perceptionsimulation|PerfHost|PhoneSvc|PlugPlay|ProfSvc|PushToInstall|RpcLocator|Schedule|SDRSVC|SecurityHealthService|SEMgrSvc|SENS|Sense|SensorDataService|SgrmBroker|ShellHWDetection|smphost|SNMPTRAP|spectrum|Spooler|sppsvc|SSDPSRV|ssh-agent|SstpSvc|StateRepository|stisvc|StorSvc|swprv|SysMain|TabletInputService|Themes|TieringEngineService|TimeBrokerSvc|TokenBroker|TrkWks|TrustedInstaller|UevAgentService|UserManager|UsoSvc|VacSvc|vds|VSS|WaaSMedicSvc|WarpJITSvc|wbengine|Wcmsvc|WdiServiceHost|WdiSystemHost|WdNisSvc|WerSvc|WinDefend|WinHttpAutoProxySvc|Winmgmt|wisvc|WlanSvc|wlidsvc|wmiApSrv|WMPNetworkSvc|WpcMonSvc|WPDBusEnum|WpnService|wscsvc|WSearch|wuauserv|cbdhsvc_\w+|CDPUserSvc_\w+|WpnUserService_\w+)$)'
  $sysmon: SourceServices ~= 'Sysmon64'
  $expl: TargetImage ~= '(?i:C:\\Windows\\Explorer\.exe)'
  $srcisparent: SourceProcessGUID = @TargetParentProcessGuid
condition: $ga and $expl and !($srcisparent or ($hosted and $win10shared) or $win10svcs
  or $sysmon or $srcwl)
severity: 10
actions: null
...

---
name: FilePrivEsc
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 11
  computers: []
matches:
  $wl: TargetFilename ~= '(?i:C:\\(Users|ProgramData)\\.*)'
  $il: IntegrityLevel ~= '(Low|Medium)'
condition: $il and !$wl
severity: 10
actions: null
...

---
name: FromDownloadedDocument
tags:
  - Office
  - Download
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $pimsoffice: ParentImage ~= '(?i:\\(excel|winword|powerpnt|outlook)\.exe)$'
  $pcl: ParentCommandLine ~= '(?i:appdata\\local\\microsoft\\windows\\temporary internet
    files\\)'
condition: $pimsoffice and $pcl
severity: 0
actions: null
...

---
name: Heur7zExec
tags:
  - Archive
  - Exec
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1193
      tactic: initial-access
      reference: https://attack.mitre.org/techniques/T1193
matches:
  $pi: ParentImage ~= '(?i:\\7zFM\.exe$)'
  $i: Image ~= '(?i:^C:\\Users\\.*\\AppData\\Local\\Temp\\)'
  $cl: CommandLine ~= '(\\Temp\\.*?((?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))|(?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf))))'
condition: $pi and ($i or $cl)
severity: 5
actions: null
...

---
name: HeurADSInCL
tags:
  - Heuristics
  - ADS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1096
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1096
matches:
  $ads: CommandLine ~= '(?i:\.[a-z0-9]{2,5}:\w*?\.[a-z0-9]{2,5})'
condition: $ads
severity: 5
actions: null
...

---
name: HeurBrowserInjection
tags:
  - Browser
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
matches:
  $ct: CallTrace ~= 'UNKNOWN'
  $src: SourceImage ~= '(?i:\\(iexplore|firefox|chrome|MicrosoftEdge|opera|vivaldi)\.exe)$'
  $dst: TargetImage ~= '(?i:\\(iexplore|firefox|chrome|MicrosoftEdge|opera|vivaldi)\.exe)$'
  $write: GrantedAccess &= '0x20'
condition: $dst and !$src and $ct and $write
severity: 8
actions: null
...

---
name: HeurCLWithCreds
tags:
  - Heuristics
  - Lateral
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $ruser: 'CommandLine ~= ''(?i: /U )'''
  $rhost: 'CommandLine ~= ''(?i: /S )'''
  $rpwd: 'CommandLine ~= ''(?i: /P )'''
condition: $ruser and $rhost and $rpwd
severity: 5
actions: null
...

---
name: HeurCallShellcode
tags:
  - Heuristics
  - RemoteThread
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 8
  computers: []
matches:
  $stfunc: StartFunction = ''
  $stmod: StartModule = ''
condition: $stfunc and $stmod
severity: 6
actions: null
...

---
name: HeurDnsFromSuspicious
tags:
  - DNS
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 22
  computers: []
matches:
  $susp: Image ~= '(?i:\\(certutil|rundll32|powershell|wscript|cscript|cmd|mshta|regsvr32|msbuild|installutil|regasm)\.exe)$'
condition: $susp
severity: 5
actions: null
...

---
name: HeurDropper
tags:
  - Heuristics
  - CreateFile
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 11
  computers: []
matches:
  $susp: Image ~= '(?i:\\(certutil|rundll32|powershell|wscript|cscript|cmd|mshta|regsvr32|msbuild|installutil|regasm)\.exe)$'
  $target: TargetFilename ~= '((?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))|(?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf)))$'
  $poltest: TargetFilename ~= '(?i:C:\\Users\\.*?\\AppData\\Local\\Temp\\__PSScriptPolicyTest_.*?\.ps1)'
condition: $susp and $target and !$poltest
severity: 8
actions: null
...

---
name: HeurLongDomain
tags:
  - DNS
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-DNS-Client/Operational: []
  computers: []
matches:
  $ldomain: QueryName ~= '.{50,}'
condition: $ldomain
severity: 6
actions: null
...

---
name: HeurMaliciousAccess
tags:
  - Heuristics
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
matches:
  $ct: CallTrace ~= 'UNKNOWN'
  $whitelist: SourceImage ~= '(?i:(?i:C:\\Windows\\Sys(wow64|tem32)\\)(sdiagnhost|svchost)\.exe)'
  $windows: TargetImage ~= '(?i:C:\\Windows\\)'
  $write: GrantedAccess &= '0x20'
  $read: GrantedAccess &= '0x10'
  $srcisparent: SourceProcessGUID = @TargetParentProcessGuid
condition: '!$srcisparent and $windows and $ct and ($write or $read) and !$whitelist'
severity: 8
actions: null
...

---
name: HeurOfficeThreat
tags:
  - Heuristics
  - WHIDS
  - MSOffice
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $anc: Ancestors ~= '(?i:\\(excel|winword|powerpnt|outlook)\.exe)'
  $tools: Image ~= '((?i:\\(rundll32|powershell|wscript|cscript|cmd|mshta|regsvr32|msbuild|installutil|regasm|dnx|rcsi|WinDbg|cdb|tracker|cmstp|msiexec|mavinject|SyncAppvPublishingServer|Odbcconf|msxsl|wmic)\.exe)|(?i:\\(certutil)\.exe))'
condition: $tools and $anc
severity: 10
actions: null
...

---
name: HeurPersistentRAT
tags:
  - Heuristics
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exist: Ancestors ~= '(?i:^System\|)'
  $anc: Ancestors ~= '(?i:C:\\Windows\\explorer\.exe)'
  $schedsvc: ParentServices ~= '^(Schedule|BrokerInfrastructure,DcomLaunch,Power,SystemEventsBroker)$'
  $tools: Image ~= '(?i:\\(ping|systeminfo|net1?|xcopy|nbtstat|bitsadmin|netstat|powershell|cmd|cscript|wscript|arp|at|certutil|dsquery|ipconfig|netsh|reg|route|schtasks|wusa|wmic|sc|rundll32|qprocess|tasklist|query)\.exe$)'
condition: $exist and $tools and !$anc and !$schedsvc
severity: 8
actions: null
...

---
name: HeurRAT
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $tools: Image ~= '(?i:\\(ping|systeminfo|net1?|xcopy|nbtstat)\.exe$)'
  $parent: ParentImage ~= '(?i:C:\\Windows\\.*\\(powershell|cmd|wscript|cscript|msiexec|net)\.exe$)'
condition: $tools and !$parent
severity: 6
actions: null
...

---
name: HeurRemotePayload
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $susp: Image ~= '((?i:\\(certutil|rundll32|powershell|wscript|cscript|cmd|mshta|regsvr32|msbuild|installutil|regasm)\.exe)|(?i:\\wmic\.exe))'
  $rempld: CommandLine ~= '(?i:(\\\\.*?\\|https?://).*\.\w{2,5})'
condition: $susp and $rempld
severity: 7
actions: null
...

---
name: HeurSpawnShell
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $shell: Image ~= '(?i:\\(powershell|cmd)\.exe$)'
  $validparent: ParentImage ~= '(?i:(c:\\Windows\\Explorer\.exe|c:\\Windows\\.*\\(powershell|cmd)\.exe)$)'
condition: $shell and !$validparent
severity: 5
actions: null
...

---
name: HeurSuspFileWrite
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4663
  computers: []
matches:
  $access: AccessMask &= '0x2'
  $user_proc: ProcessName ~= '(?i:C:\\Users\\)'
  $target: ObjectName ~= '(?i:C:\\Windows\\).*((?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf))|(?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node)))$'
condition: $access and $target
severity: 8
actions: null
...

---
name: HeurSysmonLongDomain
tags:
  - DNS
  - Heuristics
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 22
  computers: []
matches:
  $ldomain: QueryName ~= '.{50,}'
  $ip6: QueryName ~= 'ip6\.arpa\.$'
condition: $ldomain and !$ip6
severity: 6
actions: null
...

---
name: HeurWebShell
tags:
  - Heuristics
  - WHIDS
  - WebShell
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $anc: Ancestors ~= '(?:\\(tomcat.*?|w3wp|php-cgi|nginx|httpd|apache.*?)\.exe)'
  $tools: Image ~= '(?i:\\(ping|systeminfo|net1?|xcopy|nbtstat|bitsadmin|netstat|powershell|cmd|cscript|wscript|arp|at|certutil|dsquery|ipconfig|netsh|reg|route|schtasks|wusa|wmic|sc|rundll32|qprocess|tasklist|query)\.exe$)'
condition: $tools and $anc
severity: 10
actions: null
...

---
name: HeurZipExec
tags:
  - Archive
  - Exec
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1193
      tactic: initial-access
      reference: https://attack.mitre.org/techniques/T1193
matches:
  $pi: ParentImage ~= '(?i:C:\\Windows\\Explorer\.exe$)'
  $cl: CommandLine ~= '(?i:\\Temp.*?\\[^\\]*\.zip\\[^\\]*((?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))|(?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf))))'
condition: $pi and $cl
severity: 5
actions: null
...

---
name: HeuristicSamlibDll
tags:
  - Mimikatz
  - Credentials
  - DLL
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
matches:
  $il1: ImageLoaded ~= '(?i:\\samlib.dll$)'
  $system32: Image ~= '(?i:C:\\Windows\\System32\\[^\\]*?\.exe)'
  $programfile: Image ~= '(?i:C:\\Program Files.*?\\.*)'
  $exp: Image ~= '(?i:^C:\\Windows\\explorer.exe$)'
condition: $il1 and !$system32 and !$programfile and !$exp
severity: 6
actions: null
...

---
name: HeuristicVaultcliDll
tags:
  - Mimikatz
  - Credentials
  - DLL
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
matches:
  $il1: ImageLoaded ~= '(?i:\\vaultcli.dll$)'
  $system32: Image ~= '(?i:C:\\Windows\\System32\\[^\\]*?\.exe)'
  $searchui: Image ~= '(?i:(?i:C:\\Windows\\SystemApps\\).*?\\searchui\.exe)'
condition: $il1 and !($system32 or $searchui)
severity: 6
actions: null
...

---
name: HiddenPsExec
tags:
  - Powershell
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $psexec: Product = 'Sysinternals PsExec'
  $im: Image ~= '(?i:\\psexe(c|svc).exe$)'
condition: $psexec and !$im
severity: 9
actions: null
...

---
name: HighlyPolymorphicCode
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 25
  computers: []
meta:
  attack:
    - id: T1093
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1093
matches:
  $lowboundproc: ProcessIntegrity >= '50'
condition: $lowboundproc
severity: 10
actions: null
...

---
name: InfoRemotePath
tags:
  - Info
  - Lateral
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $rpath: CommandLine ~= '(?i:\\\\[\w\.]+)'
condition: $rpath
severity: 0
actions: null
...

---
name: InfoSuspiciousParent
tags:
  - Info
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $susp: ParentImage ~= '(?i:\\(certutil|rundll32|powershell|wscript|cscript|cmd|mshta|regsvr32|msbuild|installutil|regasm)\.exe)$'
condition: $susp
severity: 0
actions: null
...

---
name: LargeBase64
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $lb64: CommandLine ~= '[0-9A-Za-z]{512,}'
condition: $lb64
severity: 3
actions: null
...

---
name: LargeCL512
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $lcl: CommandLine ~= '.{512,}'
  $llcl: CommandLine ~= '.{999,}'
  $wlp1: Image ~= '^C:\\Program Files.*?\\Mozilla Firefox\\firefox\.exe$'
  $wlp2: Image ~= '^C:\\Program Files.*?\\Google\\Chrome\\Application\\chrome\.exe$'
  $wlp3: Image ~= '(?i:Java.*\\jp2launcher.exe$)'
  $wlp4: Image ~= '(?i:\\(java\.exe))'
condition: $lcl and !($llcl or $wlp1 or $wlp2 $wlp3 or $wlp4)
severity: 2
actions: null
...

---
name: LargeCL999
tags:
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $lcl: CommandLine ~= '.{999,}'
  $wlp1: Image ~= '^C:\\Program Files.*?\\Mozilla Firefox\\firefox\.exe$'
  $wlp2: Image ~= '^C:\\Program Files.*?\\Google\\Chrome\\Application\\chrome\.exe$'
  $wlp3: Image ~= '(?i:Java.*\\jp2launcher.exe$)'
  $wlp4: Image ~= '(?i:\\(java\.exe))'
condition: $lcl and !$wlp1 and !$wlp2 and !$wlp3 and !$wlp4
severity: 3
actions: null
...

---
name: LateralWMI
tags:
  - WMI
  - Lateral
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $wmi: Image ~= '(?i:\\wmic\.exe$)'
  $node: CommandLine ~= '(?i:/node:)'
condition: $wmi and $node
severity: 8
actions: null
...

---
name: LogonFromExternal
tags:
  - Lateral
  - Security
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4624
  computers: []
matches:
  $iplh1: IpAddress = '-'
  $iplh2: IpAddress = '127.0.0.1'
  $iplh3: IpAddress = '::1'
  $privip: IpAddress ~= '(?i:(^127\.)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.))'
condition: '!($privip or $iplh1 or $iplh2 or $iplh3)'
severity: 10
actions: null
...

---
name: MSOfficeThreat
tags:
  - Office
  - Threat
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1193
      tactic: initial-access
      reference: https://attack.mitre.org/techniques/T1193
matches:
  $pimsoffice: ParentImage ~= '(?i:\\(excel|winword|powerpnt|outlook)\.exe)$'
  $susp: Image ~= '(?i:\\(certutil|rundll32|powershell|wscript|cscript|cmd|mshta|regsvr32|msbuild|installutil|regasm)\.exe)$'
  $fp1: CommandLine ~= '(?i:shell32\.dll,(OpenAs_RunDLL|SHCreateLocalServerRunDll|Control_RunDLL))'
condition: $pimsoffice and !$fp1 and $susp
severity: 8
actions: null
...

---
name: MaliciousLsassAccess
tags:
  - Mimikatz
  - Credentials
  - Lsass
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
meta:
  attack:
    - id: T1003
      tactic: Credential Access
      reference: https://attack.mitre.org/techniques/T1003/
matches:
  $ct: CallTrace ~= 'UNKNOWN'
  $lsass: TargetImage ~= '(?i:\\lsass\.exe$)'
condition: $lsass and $ct
severity: 10
actions: null
...

---
name: MaliciousSvchostAccess
tags:
  - Invoke-Phant0m
  - SvcHost
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
matches:
  $ct: CallTrace ~= 'UNKNOWN'
  $svchost: TargetImage ~= '(?i:windows\\sys(tem32|wow64)\\svchost\.exe$)'
condition: $svchost and $ct
severity: 10
actions: null
...

---
name: MediumPolymorphicCode
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 25
  computers: []
meta:
  attack:
    - id: T1093
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1093
matches:
  $lowboundproc: ProcessIntegrity >= '15'
  $upboundproc: ProcessIntegrity < '50'
condition: $lowboundproc and $upboundproc
severity: 8
actions: null
...

---
name: NTLMDowngradeAttack
tags:
  - Credentials
  - Lsass
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 13
  computers: []
meta:
  attack:
    - id: T1003
      tactic: Credential Access
      reference: https://attack.mitre.org/techniques/T1003/
matches:
  $ntlmminclientsec: TargetObject ~= '^(?i:HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\NtlmMinClientSec)'
  $lmcompatlevel: TargetObject ~= '^(?i:HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\LMCompatibilityLevel)'
  $restsendntlmtraffic: TargetObject ~= '^(?i:HKLM\\System\\CurrentControlSet\\Control\\Lsa\\MSV1_0\\RestrictSendingNTLMTraffic)'
  $setval: EventType = 'SetValue'
  $v0x0: Details = 'DWORD (0x00000000)'
  $v0x1: Details = 'DWORD (0x00000001)'
  $v0x2: Details = 'DWORD (0x00000002)'
condition: ($lmcompatlevel and $setval and ($v0x0 or $v0x1 or $v0x2)) or ($restsendntlmtraffic
  and $setval and $v0x0) or $ntlmminclientsec
severity: 10
actions: null
...

---
name: NTLMDowngradeAttackSecurity
tags:
  - Credentials
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4657
  computers: []
meta:
  attack:
    - id: T1003
      tactic: Credential Access
      reference: https://attack.mitre.org/techniques/T1003/
matches:
  $msv1key: ObjectName ~= '(?i:\\SYSTEM\\ControlSet.*?\\Control\\Lsa\\MSV1_0)'
  $lsakey: ObjectName ~= '(?i:\\SYSTEM\\ControlSet.*?\\Control\\Lsa)'
  $restsendntlmtraffic: ObjectValueName = 'RestrictSendingNTLMTraffic'
  $lmcompatlevel: ObjectValueName = 'LMCompatibilityLevel'
  $ntlmminclientsec: ObjectValueName = 'NtlmMinClientSec'
condition: '($lsakey and $lmcompatlevel) or ($msv1key and ($restsendntlmtraffic or
  $ntlmminclientsec)) '
severity: 10
actions: null
...

---
name: Nbtstat.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\nbtstat\.exe$)'
condition: $exe
severity: 2
actions: null
...

---
name: Net.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\net1?\.exe$)'
condition: $exe
severity: 2
actions: null
...

---
name: NewADS
tags:
  - ADS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 15
  computers: []
meta:
  attack:
    - id: T1096
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1096
matches:
  $broker: Image ~= '(?i:C:\\Windows\\system32\\browser_broker.exe)'
  $target: TargetFilename ~= '(?i::Zone\.Identifier$)'
condition: '!($broker and $target)'
severity: 0
actions: null
...

---
name: NewAutorun
tags:
  - Registry
  - Autorun
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 13
  computers: []
meta:
  attack:
    - id: T1060
      tactic: persistence
      reference: https://attack.mitre.org/techniques/T1060
matches:
  $eventtype: EventType = 'SetValue'
  $run: TargetObject ~= '(?i:(?i:\\SOFTWARE(\\WOW6432Node)??)\\Microsoft\\Windows\\CurrentVersion\\Run)'
  $runonce: TargetObject ~= '(?i:(?i:\\SOFTWARE(\\WOW6432Node)??)\\Microsoft\\Windows\\CurrentVersion\\RunOnce)'
  $uimls: TargetObject ~= '(?i:\\Environment\\UserInitMprLogonScript$)'
  $com: TargetObject ~= '(?i:(?i:HKCR(\\WOW6432Node)??)\\CLSID)'
condition: $eventtype and ($run or $runonce or $uimls or $com)
severity: 8
actions: null
...

---
name: NewExeCreatedInRoot
tags:
  - Heuristics
  - CreateFile
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 11
  computers: []
matches:
  $smss: Image ~= '(?i:C:\\Windows\\System32\\smss\.exe)'
  $pageswap: TargetFilename ~= '(?i:C:\\(page|swap)file\.sys)'
  $target: TargetFilename ~= '(?i:c:\\[^\\]*?((?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))|(?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf)))$)'
condition: $target and !($smss and $pageswap)
severity: 10
actions: null
...

---
name: NewLocalAdmin
tags:
  - ''
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $net: Image ~= '(?i:C:\\Windows\\Sys(tem32|wow64)\\net1?\.exe)'
  $command: CommandLine ~= '(?i:localgroup\s+Administrators.*?/ADD)'
condition: $net and $command
severity: 10
actions: null
...

---
name: NewRemoteScheduledTask
tags:
  - ScheduledTasks
  - Lateral
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1053
      tactic: privilege-escalation
      reference: https://attack.mitre.org/techniques/T1053
matches:
  $schtasks: Image ~= '(?i:^c:\\windows\\system32\\schtasks\.exe$)'
  $create: CommandLine ~= '(?i:/(create|xml))'
  $remote: CommandLine ~= '(?i:/S )'
condition: '$schtasks and $remote and $create '
severity: 7
actions: null
...

---
name: NewSchedTaskInReg
tags:
  - Registry
  - Autorun
  - ScheduledTasks
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 13
  computers: []
meta:
  attack:
    - id: T1053
      tactic: privilege-escalation
      reference: https://attack.mitre.org/techniques/T1053
matches:
  $eventtype: EventType = 'SetValue'
  $newid: TargetObject ~= '(?i:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\.*?\\Id$)'
condition: $eventtype and $newid
severity: 8
actions: null
...

---
name: NewSchedTaskOnDisk
tags:
  - ScheduledTasks
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 11
  computers: []
meta:
  attack:
    - id: T1053
      tactic: privilege-escalation
      reference: https://attack.mitre.org/techniques/T1053
matches:
  $target: TargetFilename ~= '(?i:^C:\\Windows\\Sys(tem32|wow64)\\Tasks\\)'
condition: $target
severity: 8
actions: null
...

---
name: NewScheduledTask
tags:
  - ScheduledTasks
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1053
      tactic: privilege-escalation
      reference: https://attack.mitre.org/techniques/T1053
matches:
  $schtasks: Image ~= '(?i:^c:\\windows\\sys(tem32|wow64)\\schtasks\.exe$)'
  $create: CommandLine ~= '(?i:/(xml|create))'
  $remote: CommandLine ~= '(?i:/S )'
condition: $schtasks and !$remote and $create
severity: 4
actions: null
...

---
name: NotWhitelisted
tags:
  - Whitelist
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
      - 6
      - 7
  computers: []
matches:
  $md5: extract('MD5=(?P<md5>[A-F0-9]{32})', Hashes) in whitelist
  $sha1: extract('SHA1=(?P<sha1>[A-F0-9]{40})', Hashes) in whitelist
  $sha256: extract('SHA256=(?P<sha256>[A-F0-9]{64})', Hashes) in whitelist
condition: '!($md5 and $sha1 and $sha256)'
severity: 8
actions: null
...

---
name: OfficeDropper
tags:
  - Office
  - Dropper
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 11
  computers: []
meta:
  attack:
    - id: T1193
      tactic: initial-access
      reference: https://attack.mitre.org/techniques/T1193
matches:
  $office: Image ~= '(?i:\\(excel|winword|powerpnt|outlook)\.exe)$'
  $target: TargetFilename ~= '((?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))|(?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf)))$'
condition: $office and $target
severity: 8
actions: null
...

---
name: OfficeDropperExec
tags:
  - Office
  - Dropper
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1193
      tactic: initial-access
      reference: https://attack.mitre.org/techniques/T1193
matches:
  $pimsoffice: ParentImage ~= '(?i:\\(excel|winword|powerpnt|outlook)\.exe)$'
  $whitelisted: Image ~= '^((?i:C:\\Windows\\)|(?i:C:\\(PROGRA~(1|2)|Program Files.*?)\\)|(?i:C:\\ProgramData\\AppV\\))'
condition: $pimsoffice and !$whitelisted
severity: 8
actions: null
...

---
name: PSC#Win32API
tags:
  - Powershell
  - C#
  - ScriptBlock
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-PowerShell/Operational: []
  computers: []
matches:
  $api: ScriptBlockText ~= '(?i:(OpenProcess|OpenThread|SetThreadContext|OpenThreadToken|GetProcAddress|OpenThreadToken|OpenProcessToken|CreateProcess|WriteProcessMemory|ReadProcessMemory|VirtualAlloc))'
condition: $api
severity: 7
actions: null
...

---
name: PSInvokeExpression
tags:
  - Powershell
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-PowerShell/Operational:
      - 4103
  computers: []
meta:
  attack:
    - id: T1202
      tactic: Defense Evasion
      reference: https://attack.mitre.org/techniques/T1202/
matches:
  $ci: Payload ~= 'CommandInvocation\(Invoke-Expression\)'
condition: $ci
severity: 6
actions: null
...

---
name: Ping.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\ping\.exe$)'
condition: $exe
severity: 2
actions: null
...

---
name: PowershellEmbeddedC#
tags:
  - Powershell
  - EmbeddedCode
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $ps: ParentImage ~= '(?i:\\powershell.exe$)'
  $csc: Image ~= '(?i:\\csc.exe$)'
condition: $csc and $ps
severity: 3
actions: null
...

---
name: PowershellExecEnc
tags:
  - Powershell
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1202
      tactic: Defense Evasion
      reference: https://attack.mitre.org/techniques/T1202/
matches:
  $i: Image ~= '(?i:\\powershell.exe$)'
  $enc: 'CommandLine ~= ''(?i: (-|/)e[ncodedcommands]* )'''
condition: $i and $enc
severity: 5
actions: null
...

---
name: PowershellLargeCL
tags:
  - Heuristics
  - CL
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $lcl: CommandLine ~= '.{512,}'
  $ps: Image ~= '(?i:\\powershell.exe$)'
condition: $lcl and $ps
severity: 4
actions: null
...

---
name: PowershellSamlibDll
tags:
  - Mimikatz
  - Credentials
  - Powershell
  - DLL
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
matches:
  $il: ImageLoaded ~= '(?i:\\samlib.dll$)'
  $ps: Image ~= '(?i:\\powershell\.exe$)'
condition: $ps and $il
severity: 8
actions: null
...

---
name: PowershellStdin
tags:
  - Powershell
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1202
      tactic: Defense Evasion
      reference: https://attack.mitre.org/techniques/T1202/
matches:
  $ps: Image ~= '(?i:\\powershell.exe$)'
  $arg: 'CommandLine ~= ''(?i: (-|/)c[ommand]*\s+-)'''
condition: $ps and $arg
severity: 5
actions: null
...

---
name: ProcPrivEsc
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
matches:
  $ga: GrantedAccess &= '0x20'
  $srclow: SourceIntegrityLevel = 'Low'
  $srcmed: SourceIntegrityLevel = 'Medium'
  $srchigh: SourceIntegrityLevel = 'High'
  $tgtmed: TargetIntegrityLevel = 'Medium'
  $tgthigh: TargetIntegrityLevel = 'High'
  $tgtsys: TargetIntegrityLevel = 'System'
condition: $ga and (($srclow and ($tgtmed or $tgthigh or $tgtsys)) or ($srcmed and
  ($tgthigh or $tgtsys)) or ($srchigh and $tgtsys))
severity: 8
actions: null
...

---
name: ProcessCreate
tags: null
params:
  filter: true
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: null
severity: 0
actions: null
...

---
name: PsExec
tags:
  - Powershell
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $psexec: Product = 'Sysinternals PsExec'
  $im: Image ~= '(?i:\\psexe(c|svc).exe$)'
condition: $psexec and $im
severity: 7
actions: null
...

---
name: PsExec4624
tags:
  - Lateral
  - Security
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 4624
  computers: []
matches:
  $psexec: ProcessName ~= '(?i:\\PSEXESVC\.exe$)'
condition: $psexec
severity: 5
actions: null
...

---
name: PsExecCommand
tags:
  - Powershell
  - Heuristics
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $psexesvc: ParentImage ~= '(?i:\\psexesvc.exe$)'
condition: $psexesvc
severity: 10
actions: null
...

---
name: Reg.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\reg\.exe$)'
condition: $exe
severity: 2
actions: null
...

---
name: Regsvr32ApplockerBypass
tags:
  - Regsvr32
  - AppLockerBypass
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1117
      tactic: execution
      reference: https://attack.mitre.org/techniques/T1117
matches:
  $im: Image ~= '(?i:^c:\\windows\\sys(wow64|tem32)\\regsvr32.exe$)'
  $sw1: 'CommandLine ~= ''(?i: /n )'''
  $sw2: 'CommandLine ~= ''(?i: /s )'''
  $sw3: 'CommandLine ~= ''(?i: /u )'''
  $sw4: 'CommandLine ~= ''(?i: /i:)'''
condition: $im and $sw4 and $sw3 and $sw2 and $sw1
severity: 10
actions: null
...

---
name: RunningScheduledTask
tags:
  - ScheduledTasks
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1053
      tactic: privilege-escalation
      reference: https://attack.mitre.org/techniques/T1053
matches:
  $schtasks: ParentImage ~= '(?i:^c:\\windows\\system32\\schtasks\.exe$)'
condition: $schtasks
severity: 3
actions: null
...

---
name: SecurityLogClearing
tags:
  - PostExploit
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Security:
      - 1102
  computers: []
meta:
  attack:
    - id: T1070
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1070
severity: 8
actions: null
...

---
name: ServiceDeletion
tags:
  - Services
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $sc: Image ~= '(?i:sc.exe$)'
  $op: 'CommandLine ~= ''(?i: (delete) )'''
condition: $sc and $op
severity: 3
actions: null
...

---
name: StopSvchostAccess
tags:
  - Invoke-Phant0m
  - SvcHost
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
matches:
  $svchost: TargetImage ~= '(?i:C:\\windows\\sys(tem32|wow64)\\svchost\.exe)'
  $wl: SourceImage ~= '((?i:C:\\ProgramData\\Microsoft\\Windows Defender\\platform\\.*?\\MsMpEng\.exe|C:\\Program
    Files.*?\\Windows Defender\\.*?\.exe)|(?i:C:\\Windows\\sysmon(64)?\.exe)|(?i:C:\\Windows\\Sys(wow64|tem32)\\[^\\]*\.exe)|(?i:C:\\Windows\\sys(tem32|wow64)\\wbem\\wmiprvse\.exe))'
  $stopresume: GrantedAccess &= '0x0800'
  $terminate: GrantedAccess &= '0x0001'
condition: $svchost and ($stopresume or $terminate) and !$wl
severity: 7
actions: null
...

---
name: SuspWMIC
tags:
  - WMI
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $wmic: Image ~= '(?i:\\wmic\.exe$)'
  $proc: CommandLine ~= '(?i:process\s+call\s+create)'
condition: $wmic and $proc
severity: 8
actions: null
...

---
name: SuspWriteAccess
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
meta:
  attack:
    - id: T1055
      tactic: privilege-escalation
      reference: https://attack.mitre.org/techniques/T1055
matches:
  $ga: GrantedAccess &= '0x20'
  $wlsvcs: SourceServices ~= '(?i:(Sysmon64|Appinfo|PcaSvc|Themes))'
  $srcwl: SourceImage ~= '(?i:(?i:C:\\Windows\\Sys(wow64|tem32)\\)(conhost|csrss|lsass)\.exe)'
  $trgwl: TargetImage ~= '(?i:(?i:C:\\(PROGRA~(1|2)|Program Files.*?)\\WindowsApps\\)(Microsoft\.MicrosoftOfficeHub_.*?\\LocalBridge\.exe))'
  $srcisparent: SourceProcessGUID = @TargetParentProcessGuid
  $srcistarget: SourceImage = @TargetImage
  $srcissystem: SourceIntegrityLevel = 'System'
condition: $ga and !($wlsvcs or $srcwl or $trgwl or $srcissystem or $srcisparent or
  $srcistarget)
severity: 8
actions: null
...

---
name: SuspiciousADS
tags:
  - ADS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 15
  computers: []
meta:
  attack:
    - id: T1096
      tactic: defense-evasion
      reference: https://attack.mitre.org/techniques/T1096
matches:
  $target: TargetFilename ~= '(?i:((?i:(\.ps1|\.bat|\.cmd|\.vb|\.vbs|\.vbscript|\.vbe|\.js|\.jse|\.ws|\.wsf))|(?i:(\.acm|\.ax|\.com|\.cpl|\.dic|\.dll|\.drv|\.ds|\.efi|\.exe|\.grm|\.iec|\.ime|\.lex|\.msstyles|\.mui|\.ocx|\.olb|\.rll|\.rs|\.scr|\.sys|\.tlb|\.tsp|\.winmd|\.node))))$'
condition: $target
severity: 8
actions: null
...

---
name: SuspiciousLsassAccess
tags:
  - Mimikatz
  - Credentials
  - Lsass
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 10
  computers: []
meta:
  attack:
    - id: T1003
      tactic: Credential Access
      reference: https://attack.mitre.org/techniques/T1003/
matches:
  $ctwdef: CallTrace ~= '(?i:windows defender)'
  $ga: GrantedAccess &= '0x10'
  $lsass: TargetImage ~= '(?i:\\lsass\.exe$)'
  $wmiprvse: SourceImage ~= '(?i:(?i:C:\\Windows\\Sys(wow64|tem32)\\)wbem\\wmiprvse\.exe)'
  $taskmgr: SourceImage ~= '(?i:(?i:C:\\Windows\\Sys(wow64|tem32)\\)taskmgr\.exe)'
  $boot: SourceImage ~= '(?i:C:\\Windows\\system32\\(wininit|csrss)\.exe)'
condition: $lsass and $ga and !($ctwdef or $wmiprvse or $taskmgr or $boot)
severity: 8
actions: null
...

---
name: SuspiciousRundll32
tags:
  - Rundll32
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
meta:
  attack:
    - id: T1085
      tactic: execution
      reference: https://attack.mitre.org/techniques/T1085
matches:
  $im: Image ~= '(?i:^c:\\windows\\sys(wow64|tem32)\\rundll32.exe$)'
  $pgfiles: ImageLoaded ~= '(?i:^C:\\(PROGRA~2|Program Files.*?)\\)'
  $windows: ImageLoaded ~= '(?i:^C:\\Windows\\)'
condition: $im and !($pgfiles or $windows)
severity: 6
actions: null
...

---
name: SuspiciousService
tags:
  - SvcHost
  - ImageLoaded
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $parent: ParentImage ~= '(?i:C:\\Windows\\(System32|SysWOW64)\\services\.exe)'
  $windows: Image ~= '(?i:C:\\Windows\\)'
  $programfile: Image ~= '(?i:C:\\(PROGRA~2|Program Files.*?)\\.*)'
condition: $parent and !$windows and !$programfile
severity: 4
actions: null
...

---
name: SuspiciousServiceCreated
tags:
  - Services
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $sc: Image ~= '(?i:sc.exe$)'
  $op: 'CommandLine ~= ''(?i: (create) )'''
  $binpath: CommandLine ~= '?i:(binPath=.*?C:\\Windows)'
condition: $sc and $op and !$binpath
severity: 7
actions: null
...

---
name: SuspiciousServiceInstallation
tags:
  - Services
  - Registry
  - Autorun
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 13
  computers: []
matches:
  $eventtype: EventType = 'SetValue'
  $key1: TargetObject ~= '(?i:^HKLM\\System\\CurrentControlSet\\services\\.*?\\ImagePath$)'
  $key2: TargetObject ~= '(?i:^HKLM\\System\\CurrentControlSet\\services\\.*?\\Parameters\\ServiceDll$)'
  $systemroot: Details ~= '(?i:%%SystemRoot%%)'
  $service: Image ~= '(?i:C:\\Windows\\system32\\services.exe)'
condition: $eventtype and ($key1 or $key2) and !($systemroot or $service)
severity: 8
actions: null
...

---
name: SvcHostBadParent
tags:
  - SvcHost
  - Heuristics
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $svchost: Image ~= '(?i:^c:\\windows\\sys(tem32|wow64)\\svchost\.exe$)'
  $pservices: ParentImage ~= '(?i:^C:\\Windows\\sys(tem32|wow64)\\(services|svchost)\.exe$)'
condition: $svchost and !$pservices
severity: 7
actions: null
...

---
name: SvcHostMimic
tags:
  - SvcHost
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $im: Image ~= '(?i:\\svchost)'
  $svchost: Image ~= '(?i:c:\\windows\\sys(tem32|wow64)\\svchost.exe$)'
condition: $im and !$svchost
severity: 7
actions: null
...

---
name: SvcHostUnsignedDll
tags:
  - SvcHost
  - ImageLoaded
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
matches:
  $im: Image ~= '(?i:C:\\Windows\\System32\\svchost\.exe)'
  $unsigned: Signed = 'false'
condition: $im and $unsigned
severity: 6
actions: null
...

---
name: SvcHostUntrustedDLL
tags:
  - SvcHost
  - ImageLoaded
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
matches:
  $im: Image ~= '(?i:C:\\Windows\\System32\\svchost\.exe)'
  $trusted: Signature ~= '^(Microsoft Windows|Microsoft Corporation|Microsoft Windows
    Component Publisher|Microsoft Windows Publisher|Microsoft Windows 3rd party Component)$'
condition: $im and !$trusted
severity: 7
actions: null
...

---
name: SysmonConfigChanged
tags:
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 16
  computers: []
severity: 8
actions: null
...

---
name: SysmonConfigTampering
tags:
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 12
      - 13
  computers: []
matches:
  $set: EventType = 'SetValue'
  $del: EventType = 'DeleteValue'
  $sysmon: Image ~= '(?i:C:\\Windows\\Sysmon.exe)'
  $target: TargetObject ~= '(?i:HKLM\\System\\CurrentControlSet\\services\\SysmonDrv\\Parameters\\(Options|HashingAlgorithm|Rules))'
condition: $target and ($set or $del) and !$sysmon
severity: 10
actions: null
...

---
name: SysmonDomainInMisp
tags:
  - DNS
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 22
  computers: []
matches:
  $domain-bl: extract('(?P<dom>\w+\.\w+$)',QueryName) in misp'
  $subdomain-bl: extract('(?P<sub>\w+\.\w+\.\w+$)',QueryName) in misp'
  $subsubdomain-bl: extract('(?P<subsub>\w+\.\w+\.\w+\.\w+$)',QueryName) in misp'
condition: $domainBL or $subdomainBL or $subsubdomainBL
severity: 10
actions: null
...

---
name: SysmonFingerprinting
tags:
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $sysmon: Product = 'Sysinternals Sysmon'
  $sysmonim: Image ~= '(?i:C:\\Windows\\.*sysmon.*)'
  $arg: CommandLine ~= '(?i:\s-c\s*$)'
condition: ($sysmon or $sysmonim) and $arg
severity: 6
actions: null
...

---
name: SysmonRegFingerprinting
tags:
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 12
  computers: []
matches:
  $create: EventType = 'CreateKey'
  $sysmon: Image ~= '(?i:C:\\Windows\\Sysmon.exe)'
  $target: TargetObject ~= '(?i:^HKLM\\System\\CurrentControlSet\\services\\SysmonDrv\\Parameters)'
condition: $target and $create and !$sysmon
severity: 7
actions: null
...

---
name: SysmonStateChanged
tags:
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 4
  computers: []
matches:
  $start: State = 'Started'
condition: '!$start'
severity: 8
actions: null
...

---
name: SystemInfo.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\systeminfo\.exe$)'
condition: $exe
severity: 2
actions: null
...

---
name: Taskkill.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\taskkill\.exe$)'
condition: $exe
severity: 2
actions: null
...

---
name: Tasklist.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\tasklist\.exe$)'
condition: $exe
severity: 2
actions: null
...

---
name: UnkDstPort
tags:
  - Network
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 3
  computers: []
matches:
  $dstlocalhost: DestinationIp = '127.0.0.1'
  $dstprivip: DestinationIp ~= '(?i:(^127\.)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.))'
  $unk: DestinationPortName ~= '^$'
  $system: Image ~= '^(?i:C:\\Windows\\Sys(wow64|tem32)\\)'
  $init: Initiated = 'true'
condition: '!$system and !$dstprivip and !$dstlocalhost and $unk and $init'
severity: 8
actions: null
...

---
name: UnkPrivDstPort
tags:
  - Network
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 3
  computers: []
matches:
  $dstlocalhostv6: DestinationIp = '0:0:0:0:0:0:0:1'
  $dstlocalhost: DestinationIp = '127.0.0.1'
  $dstprivip: DestinationIp ~= '(?i:(^127\.)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.))'
  $unk: DestinationPortName ~= '^$'
  $system: Image ~= '^(?i:C:\\Windows\\Sys(wow64|tem32)\\)'
  $init: Initiated = 'true'
condition: '!$system and $dstprivip and !($dstlocalhost or $dstlocalhostv6) and $unk
  and $init'
severity: 6
actions: null
...

---
name: UnknownServices
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exist: Services ~= '.'
  $na: Services = 'N/A'
  $hosted: Image ~= '(?i:\\(lsass|svchost)\.exe$)'
  $sysmon: Services = 'Sysmon64'
  $win10shared: Services ~= '(?i:(^|,)(AJRouter|AppIDSvc|AppMgmt|AssignedAccessManagerSvc|AxInstSV|BDESVC|BFE|BrokerInfrastructure|BTAGService|bthserv|CertPropSvc|CoreMessagingRegistrar|CscService|DcomLaunch|DeviceAssociationService|DevQueryBroker|diagsvc|DisplayEnhancementService|dmwappushservice|dot3svc|DsSvc|Eaphost|EFS|embeddedmode|EntAppSvc|fdPHost|FDResPub|fhsvc|FrameServer|GraphicsPerfSvc|hidserv|HvHost|icssvc|IKEEXT|IpxlatCfgSvc|KeyIso|KtmRm|lltdsvc|LxpSvc|mpssvc|MSiSCSI|NaturalAuthentication|NcaSvc|NcdAutoSetup|Netlogon|Netman|NetSetupSvc|NetTcpPortSharing|p2pimsvc|p2psvc|PeerDistSvc|pla|PNRPAutoReg|PNRPsvc|PolicyAgent|Power|PrintNotify|QWAVE|RasAuto|RasMan|RemoteAccess|RemoteRegistry|RetailDemo|RmSvc|RpcEptMapper|RpcSs|SamSs|SCardSvr|ScDeviceEnum|SCPolicySvc|seclogon|SensorService|SensrSvc|SessionEnv|SharedAccess|SharedRealitySvc|shpamsvc|SmsRouter|svsvc|SystemEventsBroker|TapiSrv|TermService|TroubleshootingSvc|tzautoupdate|UmRdpService|upnphost|VaultSvc|vmicguestinterface|vmicheartbeat|vmickvpexchange|vmicrdv|vmicshutdown|vmictimesync|vmicvmsession|vmicvss|W32Time|WalletService|WbioSrvc|wcncsvc|WebClient|Wecsvc|WEPHOSTSVC|wercplsupport|WFDSConMgrSvc|WiaRpc|WinRM|wlpasvc|WManSvc|workfolderssvc|WwanSvc|XblAuthManager|XblGameSave|XboxGipSvc|XboxNetApiSvc|AarSvc_\w+|BcastDVRUserService_\w+|BluetoothUserService_\w+|CaptureService_\w+|ConsentUxUserSvc_\w+|DeviceAssociationBrokerSvc_\w+|DevicePickerUserSvc_\w+|DevicesFlowUserSvc_\w+|MessagingService_\w+|OneSyncSvc_\w+|PimIndexMaintenanceSvc_\w+|PrintWorkflowUserSvc_\w+|UnistoreSvc_\w+|UserDataSvc_\w+)(,|$))'
  $win10svcs: Services ~= '(?i:^(ALG|Appinfo|AppReadiness|AppVClient|AppXSvc|AudioEndpointBuilder|Audiosrv|autotimesvc|BITS|BthAvctpSvc|camsvc|CDPSvc|ClipSVC|COMSysApp|CryptSvc|defragsvc|DeviceInstall|Dhcp|diagnosticshub.standardcollector.service|DiagTrack|DispBrokerDesktopSvc|DmEnrollmentSvc|Dnscache|DoSvc|DPS|DsmSvc|DusmSvc|EventLog|EventSystem|Fax|FontCache|gpsvc|InstallService|iphlpsvc|LanmanServer|LanmanWorkstation|lfsvc|LicenseManager|lmhosts|LSM|MapsBroker|MSDTC|msiserver|NcbService|netprofm|NgcCtnrSvc|NgcSvc|NlaSvc|nsi|PcaSvc|perceptionsimulation|PerfHost|PhoneSvc|PlugPlay|ProfSvc|PushToInstall|RpcLocator|Schedule|SDRSVC|SecurityHealthService|SEMgrSvc|SENS|Sense|SensorDataService|SgrmBroker|ShellHWDetection|smphost|SNMPTRAP|spectrum|Spooler|sppsvc|SSDPSRV|ssh-agent|SstpSvc|StateRepository|stisvc|StorSvc|swprv|SysMain|TabletInputService|Themes|TieringEngineService|TimeBrokerSvc|TokenBroker|TrkWks|TrustedInstaller|UevAgentService|UserManager|UsoSvc|VacSvc|vds|VSS|WaaSMedicSvc|WarpJITSvc|wbengine|Wcmsvc|WdiServiceHost|WdiSystemHost|WdNisSvc|WerSvc|WinDefend|WinHttpAutoProxySvc|Winmgmt|wisvc|WlanSvc|wlidsvc|wmiApSrv|WMPNetworkSvc|WpcMonSvc|WPDBusEnum|WpnService|wscsvc|WSearch|wuauserv|cbdhsvc_\w+|CDPUserSvc_\w+|WpnUserService_\w+)$)'
condition: $exist and !($na or $sysmon or ($hosted and $win10shared) or $win10svcs)
severity: 10
actions: null
...

---
name: UntrustedDriverLoaded
tags:
  - DriverLoaded
  - Sysmon
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 6
  computers: []
meta:
  attack:
    - id: T1014
      tactic: Defense Evasion
      reference: https://attack.mitre.org/techniques/T1014/
matches:
  $trusted: Signature ~= '^(Microsoft Windows|Microsoft Corporation)$'
condition: '!$trusted'
severity: 10
actions: null
...

---
name: UntrustedService
tags:
  - WHIDS
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 7
  computers: []
meta:
  attack:
    - id: T1035
      tactic: Execution
      reference: https://attack.mitre.org/techniques/T1035/
matches:
  $loaded: ImageLoaded ~= '(?i:\.exe$)'
  $pservice: ParentImage ~= '(?i:(?i:C:\\Windows\\Sys(wow64|tem32)\\)services\.exe)'
  $trusted: Signature ~= '^(Microsoft Windows|Microsoft Corporation|Microsoft Windows
    Component Publisher|Microsoft Windows Publisher|Microsoft Windows 3rd party Component)$'
condition: $loaded and $pservice and !$trusted
severity: 10
actions: null
...

---
name: UserTempExec
tags:
  - Heuristics
  - Exec
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $pi: ParentImage ~= '^C:\\Users\\.*\\AppData\\Local\\Temp\\'
  $i: Image ~= '^C:\\Users\\.*\\AppData\\Local\\Temp\\'
condition: $pi or $i
severity: 4
actions: null
...

---
name: WMIApplockerBypassAttempt
tags:
  - WMI
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1220
      tactic: execution
      reference: https://attack.mitre.org/techniques/T1220
matches:
  $wmi: Image ~= '(?i:\\wmic\.exe$)'
  $format: CommandLine ~= '(?i:/format:.*\.xsl)'
condition: $wmi and $format
severity: 8
actions: null
...

---
name: WMIEvents
tags:
  - WMI
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 19
      - 20
      - 21
  computers: []
meta:
  attack:
    - id: T1084
      tactic: persistence
      reference: https://attack.mitre.org/techniques/T1084
severity: 10
actions: null
...

---
name: WMIPrvseCommand
tags:
  - WMI
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
meta:
  attack:
    - id: T1047
      tactic: execution
      reference: https://attack.mitre.org/techniques/T1047
matches:
  $wmi: ParentImage ~= '(?i:\\wmiprvse\.exe$)'
condition: $wmi
severity: 8
actions: null
...

---
name: WindowsTempExec
tags:
  - Heuristics
  - Exec
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $wtpi: ParentImage ~= '^C:\\Windows\\Temp'
  $wti: Image ~= '^C:\\Windows\\Temp'
condition: $wtpi or $wti
severity: 3
actions: null
...

---
name: Xcopy.exe
tags:
  - Tool
params:
  filter: false
  disable: false
match-on:
  log-type: winevt
  events:
    Microsoft-Windows-Sysmon/Operational:
      - 1
  computers: []
matches:
  $exe: Image ~= '(?i:\\xcopy\.exe$)'
condition: $exe
severity: 2
actions: null
...

